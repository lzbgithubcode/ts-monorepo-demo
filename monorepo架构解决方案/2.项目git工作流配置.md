**项目 git 工作流包括:**

1. 代码规范检测与格式化(js/css/html/vue/react)
2. commit-message 规范格式与检测
3. changelog 日志生成

#### 一、git 工作流的基石`Husky`

我们要设计 git 提交代码的工作流，必须清楚的知道 githooks，我们在不同的生命周期做一些事情,就需要用到插件 _[husky](https://github.com/typicode/husky)_ - git 工作流的 hooks 在提交代码的时候会触发

_注意: husky 只支持本地 hooks，不支持服务端 hooks_

- 插件[husky](https://github.com/typicode/husky)
- [官方文档](https://typicode.github.io/husky/#/)

##### 1. 安装插件

```
pnpm add husky -wD
```

##### 2. 设置安装之后自动启动 hooks

```json
// package.json
{
  "scripts": {
    "prepare": "husky install"
  }
}
```

##### 3. 初始化 husky

执行命令后再项目根目录生成`.husky文件夹`,目录下面有`_和husky.sh`

```
  npx husky install
```

##### 4. 创建`pre-commit`hooks 执行操作`npm run lint`

结果：`.husky`目录下创建 commit 之前执行脚本命令（比如运行代码格式化之类）,会在`.husky`目录创建`pre-commit`的 shell 文件

```
npx husky add .husky/pre-commit "npm run lint"
```

查看 git hooks 有多少的方式:

```
   cd .git/hooks  // 找到git的hooks目录
   ls -a    // 查看所有文件
```

**常用的 git-hooks:**

- **commit-msg**: `git commit执行前调用` 常用于校验 commit-message 的规范
- **pre-commit**: `git commit执行前调用` 常用于代码格式化以及代码规范检查
- **post-commit**: `git commit执行后调用` 不影响 commit 的结果
- **pre-push**: `git push执行前调用`
- **更多 hooks[git-hooks 官网](https://git-scm.com/docs/githooks)**

#### 二、代码检测与格式化

##### 1. eslint-代码质量检测

1.1 安装 eslint

```
pnpm add eslint -wD
```

1.2 初始化 eslint

```
命令一： pnpm create @eslint/config
命令二： npx eslint --init
命令三： npm init @eslint/config
```

1.3 初始化之后创建文件`.eslintrc.js` - 配置检测 ts 代码
检测 ts 代码需要安装配置解析器

```
pnpm add   @typescript-eslint/parser @typescript-eslint/eslint-plugin -wD
```

具体文件配置

```js
// .eslintrc.js
module.exports = {
  //设置格式的更目录
  root: true,
  // 可以支持的环境预定义的全局变量 https://eslint.org/docs/latest/user-guide/configuring/language-options#specifying-environments
  env: {
    browser: true,
    es6: true,
    node: true,
  },
  // 扩展配置-继承 https://eslint.org/docs/latest/user-guide/configuring/configuration-files#extending-configuration-files
  extends: ["eslint:recommended", "plugin:@typescript-eslint/recommended"],
  // 解析器配置
  parser: "@typescript-eslint/parser",
  // 重写规则配置
  overrides: [],
  // 配置选项 https://eslint.org/docs/latest/user-guide/configuring/language-options#specifying-parser-options
  parserOptions: {
    ecmaVersion: "latest", // 支持es最新的版本
    sourceType: "module", // script / module
    ecmaFeatures: {
      // 附加选项
      jsx: true, // 支持jsx
      greater: true, // 使用严格模式
      globalReturn: true, // 全局支持返回return
    },
  },
  // 使用插件
  plugins: ["@typescript-eslint"],
  // 规则配置 https://eslint.org/docs/latest/user-guide/configuring/rules
  rules: {},
};
```

1.4 配置代码质量检测与格式化

```json
// package.json
 "scripts": {
    "lint": "eslint --ext .ts packages/*/src/**.ts",
    "lint:fix": "npm run lint --fix"   // 尽可能多的修复问题 剩下的未修复的问题才会输出
  },
```

##### 2. prettier-格式化

1. 安装 prettier

```
pnpm add prettier -wD
```

2. 初始化 prettier

根目录创建文件`touch .prettierrc.cjs`
根目录创建文件`touch .prettierignore`

```js
module.exports = {
  // 一行最多 120 字符
  printWidth: 120,
  // 使用 2 个空格缩进
  tabWidth: 2,
  // 不使用缩进符，而使用空格
  useTabs: false,
  // 行尾需要有分号
  semi: true,
  // 使用单引号
  singleQuote: false,
  // 对象的 key 仅在必要时用引号
  quoteProps: "as-needed",
  // jsx 不使用单引号，而使用双引号
  jsxSingleQuote: true,
  // 末尾需要有逗号
  trailingComma: "all",
  // 大括号内的首尾需要空格
  bracketSpacing: true,
  // 箭头函数，只有一个参数的时候，也需要括号
  arrowParens: "always",
  // 每个文件格式化的范围是文件的全部内容
  rangeStart: 0,
  rangeEnd: Infinity,
  // 不需要写文件开头的 @prettier
  requirePragma: false,
  // 不需要自动在文件开头插入 @prettier
  insertPragma: false,
  // 使用默认的折行标准
  proseWrap: "preserve",
  // 根据显示样式决定 html 要不要折行
  htmlWhitespaceSensitivity: "css",
  // vue 文件中的 script 和 style 内不用缩进
  vueIndentScriptAndStyle: false,
  // 换行符使用 lf
  endOfLine: "auto",
  // 格式化内嵌代码
  embeddedLanguageFormatting: "auto",
};
```

忽略文件配置

```
// .prettierignore
dist
node_modules
.eslintignore
.prettierignore
```

3. 脚本配置

```json
// package.json
 "scripts": {
    "lint": "eslint --ext .ts packages/*/src/**.ts",
    "lint:fix": "npm run lint --fix",
    "format": "prettier --check --cache  \"packages/**/*.ts?(x)\"",
    "format:fix": "prettier --write --cache  \"packages/**/*.ts?(x)\""
  },
```

#### 三、git 工作流的优化`lint-staged`

`lint-staged`是 git 暂存文件上运行 linters 的工具
作用: 只校验我们提交( `git add . `)的文件代码格式，而不是去校验所有的文件的格式，可以提高校验效率,避免我们每次检查都把整个项目的代码都检查一遍
